<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperFlow Protocol - Real Presale Live</title>
    
    <link rel="stylesheet" href="presale-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Universal Wallet Modal Styles -->
    <style>
        .wallet-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .wallet-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: #1e293b;
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            transform: translateY(50px);
            transition: transform 0.3s ease;
            border: 1px solid #334155;
        }
        
        .wallet-modal.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
        }
        
        .wallet-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #334155;
            border-radius: 12px;
            background: #0f172a;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            color: #fff;
        }
        
        .wallet-option:hover {
            border-color: #2dd4bf;
            background: rgba(45, 212, 191, 0.1);
            transform: translateY(-1px);
        }
        
        .wallet-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .close-btn {
            background: #374151;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-size: 14px;
            color: #fff;
        }
        
        .close-btn:hover {
            background: #4b5563;
        }
    </style>
    
    <!-- Clean Web3 Connection -->
    <script src="https://unpkg.com/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header style="background: #1e293b; padding: 20px; border-bottom: 1px solid #334155;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center;">
                <svg width="40" height="40" viewBox="0 0 100 100" style="margin-right: 12px;">
                    <defs>
                        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#2dd4bf"/>
                            <stop offset="100%" style="stop-color:#14b8a6"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="url(#logoGrad)"/>
                    <text x="50" y="58" text-anchor="middle" fill="white" font-family="Inter" font-weight="700" font-size="32">HF</text>
                </svg>
                <div>
                    <h1 style="margin: 0; color: #2dd4bf; font-size: 24px; font-weight: 700;">HyperFlow</h1>
                    <p style="margin: 0; color: #94a3b8; font-size: 14px;">Advanced DeFi Protocol</p>
                </div>
            </div>
            
            <button id="connectWalletBtn" onclick="connectWallet()" style="background: linear-gradient(135deg, #2dd4bf, #14b8a6); border: none; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 16px;">
                Connect Wallet
            </button>
        </div>
    </header>

    <!-- Hero Section -->
    <section style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 80px 20px; text-align: center;">
        <div style="max-width: 800px; margin: 0 auto;">
            <h1 style="font-size: 48px; font-weight: 800; margin-bottom: 24px; background: linear-gradient(135deg, #2dd4bf, #14b8a6); background-clip: text; -webkit-background-clip: text; color: transparent;">
                HyperFlow Protocol Presale
            </h1>
            <p style="font-size: 20px; color: #94a3b8; margin-bottom: 40px; line-height: 1.6;">
                Join the next generation of DeFi infrastructure on HyperEVM. Fair presale with no tier discrimination.
            </p>
            
            <!-- Presale Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <div style="background: rgba(45, 212, 191, 0.1); border: 1px solid #2dd4bf; border-radius: 12px; padding: 24px;">
                    <h3 style="color: #2dd4bf; font-size: 24px; font-weight: 700; margin-bottom: 8px;">$0.0005</h3>
                    <p style="color: #94a3b8; margin: 0;">Price per FLOW</p>
                </div>
                <div style="background: rgba(45, 212, 191, 0.1); border: 1px solid #2dd4bf; border-radius: 12px; padding: 24px;">
                    <h3 style="color: #2dd4bf; font-size: 24px; font-weight: 700; margin-bottom: 8px;">50M FLOW</h3>
                    <p style="color: #94a3b8; margin: 0;">Total Presale Supply</p>
                </div>
                <div style="background: rgba(45, 212, 191, 0.1); border: 1px solid #2dd4bf; border-radius: 12px; padding: 24px;">
                    <h3 style="color: #2dd4bf; font-size: 24px; font-weight: 700; margin-bottom: 8px;">2,000 HYPE</h3>
                    <p style="color: #94a3b8; margin: 0;">Hard Cap</p>
                </div>
                <div style="background: rgba(45, 212, 191, 0.1); border: 1px solid #2dd4bf; border-radius: 12px; padding: 24px;">
                    <h3 style="color: #2dd4bf; font-size: 24px; font-weight: 700; margin-bottom: 8px;">25,000:1</h3>
                    <p style="color: #94a3b8; margin: 0;">FLOW per HYPE</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Purchase Section -->
    <div style="max-width: 500px; margin: -60px auto 0; background: #1e293b; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 1px solid #334155; position: relative; z-index: 10;">
        <div style="text-align: center; margin-bottom: 32px;">
            <h2 style="color: #2dd4bf; font-size: 28px; font-weight: 700; margin-bottom: 8px;">
                Purchase FLOW Tokens
            </h2>

            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px;">
                    Purchase Amount (HYPE tokens)
                </label>
                <input id="purchaseAmount" type="number" placeholder="Enter amount (1-2000)" min="1" max="2000" oninput="updateCalculation()" style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #fff; font-size: 16px; box-sizing: border-box;">
            </div>

            <div id="calculationSummary" style="background: #0f172a; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #94a3b8;">HYPE Tokens:</span>
                    <span id="hyTokensDisplay" style="color: #fff;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #94a3b8;">FLOW Tokens Received:</span>
                    <span id="flowTokensDisplay" style="color: #2dd4bf;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8;">Total Cost:</span>
                    <span id="totalCostDisplay" style="color: #fff; font-weight: 600;">$0.00</span>
                </div>
            </div>

            <button id="purchaseBtn" onclick="purchaseTokens()" disabled style="width: 100%; padding: 16px; border-radius: 8px; border: none; background: #334155; color: #94a3b8; font-size: 18px; font-weight: 600; cursor: not-allowed;">
                Connect Wallet to Purchase
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: #1e293b; padding: 40px; text-align: center; border-top: 1px solid #334155; margin-top: 80px;">
        <p style="color: #94a3b8; margin: 0;">
            HyperFlow Protocol ¬© 2024 | Secure Wallet Integration
        </p>
    </footer>

    <script>
        // Clean wallet connection variables
        let walletConnected = false;
        let currentWalletAddress = null;
        let isConnecting = false;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('HyperFlow presale loaded - ready for wallet connection');
        });
        
        function updateCalculation() {
            const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            const flowTokens = amount * 25000; // 25,000 FLOW per HYPE token
            const totalCost = amount * 12.5; // $12.5 per HYPE token
            
            document.getElementById('hyTokensDisplay').textContent = amount;
            document.getElementById('flowTokensDisplay').textContent = flowTokens.toLocaleString();
            document.getElementById('totalCostDisplay').textContent = '$' + totalCost.toFixed(2);
            
            const purchaseBtn = document.getElementById('purchaseBtn');
            if (walletConnected && amount > 0) {
                purchaseBtn.disabled = false;
                purchaseBtn.style.background = 'linear-gradient(135deg, #2dd4bf, #14b8a6)';
                purchaseBtn.style.color = 'white';
                purchaseBtn.style.cursor = 'pointer';
                purchaseBtn.textContent = 'Purchase Tokens';
            } else if (walletConnected) {
                purchaseBtn.disabled = true;
                purchaseBtn.style.background = '#334155';
                purchaseBtn.style.color = '#94a3b8';
                purchaseBtn.style.cursor = 'not-allowed';
                purchaseBtn.textContent = 'Enter Purchase Amount';
            }
        }
        
        // Universal wallet connection that works on ALL browsers and devices
        async function connectWallet() {
            if (isConnecting) return;
            
            console.log('=== UNIVERSAL WALLET CONNECTION ===');
            console.log('window.ethereum available:', !!window.ethereum);
            console.log('Mobile device:', isMobileDevice());
            console.log('User agent:', navigator.userAgent);
            
            isConnecting = true;
            document.getElementById('connectWalletBtn').disabled = true;
            document.getElementById('connectWalletBtn').textContent = 'Connecting...';
            
            // ALWAYS try direct connection first if ethereum is available
            if (window.ethereum) {
                console.log('Ethereum provider detected, attempting direct connection');
                try {
                    await connectInjectedWallet();
                    isConnecting = false;
                    return;
                } catch (error) {
                    console.log('Direct connection failed:', error);
                    // Only show modal if direct connection truly fails
                }
            }
            
            // Only show modal if no ethereum provider or direct connection failed
            console.log('Showing wallet selection modal');
            showWalletModal();
            isConnecting = false;
        }
        
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function showWalletModal() {
            // Create wallet modal if it doesn't exist
            let modal = document.getElementById('walletModal');
            if (!modal) {
                createWalletModal();
                modal = document.getElementById('walletModal');
            }
            modal.classList.add('show');
        }
        
        function createWalletModal() {
            const modalHTML = `
                <div id="walletModal" class="wallet-modal">
                    <div class="modal-content">
                        <h3 class="modal-title">Choose Wallet</h3>
                        
                        <button class="wallet-option" onclick="connectSpecificWallet('metamask')">
                            <span class="wallet-icon">ü¶ä</span>
                            <span>MetaMask</span>
                        </button>
                        
                        <button class="wallet-option" onclick="connectSpecificWallet('coinbase')">
                            <span class="wallet-icon">üîµ</span>
                            <span>Coinbase Wallet</span>
                        </button>
                        
                        <button class="wallet-option" onclick="connectSpecificWallet('trust')">
                            <span class="wallet-icon">üõ°Ô∏è</span>
                            <span>Trust Wallet</span>
                        </button>
                        
                        <button class="wallet-option" onclick="connectSpecificWallet('injected')">
                            <span class="wallet-icon">‚ö°</span>
                            <span>Browser Wallet</span>
                        </button>
                        
                        <button class="close-btn" onclick="closeWalletModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeWalletModal() {
            const modal = document.getElementById('walletModal');
            if (modal) {
                modal.classList.remove('show');
            }
            document.getElementById('connectWalletBtn').disabled = false;
            document.getElementById('connectWalletBtn').textContent = 'Connect Wallet';
        }
        
        async function connectInjectedWallet() {
            if (!window.ethereum) {
                throw new Error('No browser wallet detected');
            }
            
            console.log('Requesting wallet accounts...');
            
            const accounts = await window.ethereum.request({
                method: 'eth_requestAccounts'
            });
            
            console.log('Accounts received:', accounts);
            
            if (accounts.length > 0) {
                // Determine wallet type
                let walletType = 'Wallet';
                if (window.ethereum.isMetaMask) walletType = 'MetaMask';
                else if (window.ethereum.isCoinbaseWallet) walletType = 'Coinbase Wallet';
                else if (window.ethereum.isTrust) walletType = 'Trust Wallet';
                
                await handleSuccessfulConnection(accounts[0], walletType);
            } else {
                throw new Error('No accounts found');
            }
        }
        
        async function connectSpecificWallet(walletType) {
            closeWalletModal();
            
            try {
                switch (walletType) {
                    case 'injected':
                        await connectInjectedWallet();
                        break;
                    case 'metamask':
                        await connectMetaMask();
                        break;
                    case 'coinbase':
                        await connectCoinbaseWallet();
                        break;
                    case 'trust':
                        await connectTrustWallet();
                        break;
                    default:
                        throw new Error('Unknown wallet type');
                }
            } catch (error) {
                handleConnectionError(error, walletType);
            }
        }
        
        async function connectMetaMask() {
            // First try direct connection if ethereum is available
            if (window.ethereum) {
                console.log('Using existing ethereum provider for MetaMask');
                try {
                    await connectInjectedWallet();
                    return;
                } catch (error) {
                    console.log('Direct ethereum connection failed:', error);
                }
            }
            
            if (isMobileDevice()) {
                // Mobile: Use deep link only if no ethereum provider
                const metamaskUrl = `metamask://dapp/${window.location.host}${window.location.pathname}`;
                console.log('Opening MetaMask app via deep link');
                window.location.href = metamaskUrl;
                
                // Shorter timeout for better UX
                setTimeout(() => {
                    if (!walletConnected) {
                        if (confirm('MetaMask app not found. Install MetaMask?')) {
                            window.open('https://metamask.io/download/', '_blank');
                        }
                    }
                }, 2000);
            } else {
                // Desktop: Show install prompt
                if (confirm('MetaMask extension not found. Install MetaMask?')) {
                    window.open('https://metamask.io/download/', '_blank');
                }
            }
        }
        
        async function connectCoinbaseWallet() {
            if (isMobileDevice()) {
                const deepLink = `cbwallet://dapp?url=${encodeURIComponent(window.location.href)}`;
                console.log('Opening Coinbase Wallet...');
                window.location.href = deepLink;
                
                setTimeout(() => {
                    if (!walletConnected) {
                        if (confirm('Coinbase Wallet not found. Install Coinbase Wallet?')) {
                            window.open('https://wallet.coinbase.com/', '_blank');
                        }
                    }
                }, 3000);
            } else {
                if (window.ethereum?.isCoinbaseWallet) {
                    await connectInjectedWallet();
                } else {
                    if (confirm('Coinbase Wallet extension not found. Install Coinbase Wallet?')) {
                        window.open('https://wallet.coinbase.com/', '_blank');
                    }
                }
            }
        }
        
        async function connectTrustWallet() {
            if (isMobileDevice()) {
                const deepLink = `trust://dapp_browser?url=${encodeURIComponent(window.location.href)}`;
                console.log('Opening Trust Wallet...');
                window.location.href = deepLink;
                
                setTimeout(() => {
                    if (!walletConnected) {
                        if (confirm('Trust Wallet not found. Install Trust Wallet?')) {
                            window.open('https://trustwallet.com/', '_blank');
                        }
                    }
                }, 3000);
            } else {
                if (window.ethereum?.isTrust) {
                    await connectInjectedWallet();
                } else {
                    alert('Trust Wallet works best on mobile devices');
                }
            }
        }

        async function handleSuccessfulConnection(address, source) {
            walletConnected = true;
            currentWalletAddress = address;
            
            // Get chain info if possible
            let chainId = 'Unknown';
            let balance = '0';
            
            if (window.ethereum) {
                try {
                    chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    chainId = parseInt(chainId, 16);
                    
                    const web3 = new Web3(window.ethereum);
                    const balanceWei = await web3.eth.getBalance(address);
                    balance = web3.utils.fromWei(balanceWei, 'ether');
                } catch (e) {
                    console.log('Could not get chain info:', e);
                }
            }
            
            // Update UI
            document.getElementById('connectWalletBtn').textContent = 'Wallet Connected';
            document.getElementById('connectWalletBtn').style.background = '#22c55e';
            document.getElementById('connectWalletBtn').disabled = true;
            
            // Show wallet info
            const walletInfo = document.createElement('div');
            walletInfo.id = 'walletInfo';
            walletInfo.style.cssText = `
                background: rgba(34, 197, 94, 0.1);
                border: 1px solid #22c55e;
                border-radius: 8px;
                padding: 15px;
                margin-top: 15px;
                font-size: 14px;
            `;
            walletInfo.innerHTML = `
                <div><strong>Connected via ${source}:</strong> ${address.substring(0, 8)}...${address.substring(36)}</div>
                <div><strong>Chain:</strong> ${getNetworkName(chainId)}</div>
                <div><strong>Balance:</strong> ${parseFloat(balance).toFixed(4)} ETH</div>
                <button onclick="disconnectWallet()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 10px; cursor: pointer;">Disconnect</button>
            `;
            
            const existingInfo = document.getElementById('walletInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            document.getElementById('connectWalletBtn').parentNode.appendChild(walletInfo);
            
            // Update purchase calculator
            updateCalculation();
            
            console.log('‚úÖ Wallet connected:', address);
        }
        
        function handleConnectionError(error, walletType) {
            console.error('Connection error:', error);
            
            let errorMessage = 'Connection failed';
            
            if (error.code === 4001) {
                errorMessage = 'Connection rejected by user';
            } else if (error.code === -32002) {
                errorMessage = 'Connection request pending - check your wallet';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            alert(`${walletType} connection failed: ${errorMessage}`);
            
            document.getElementById('connectWalletBtn').disabled = false;
            document.getElementById('connectWalletBtn').textContent = 'Connect Wallet';
        }

        function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum',
                56: 'BSC',
                137: 'Polygon',
                999: 'HyperEVM',
                43114: 'Avalanche'
            };
            return networks[chainId] || `Chain ${chainId}`;
        }

        function disconnectWallet() {
            walletConnected = false;
            currentWalletAddress = null;
            
            document.getElementById('connectWalletBtn').textContent = 'Connect Wallet';
            document.getElementById('connectWalletBtn').style.background = 'linear-gradient(135deg, #2dd4bf, #14b8a6)';
            document.getElementById('connectWalletBtn').disabled = false;
            
            const walletInfo = document.getElementById('walletInfo');
            if (walletInfo) {
                walletInfo.remove();
            }
            
            updateCalculation();
            console.log('Wallet disconnected');
        }

        async function purchaseTokens() {
            if (!walletConnected) {
                alert('Please connect your wallet first');
                return;
            }
            
            const amount = parseFloat(document.getElementById('purchaseAmount').value);
            if (!amount || amount <= 0) {
                alert('Please enter a valid purchase amount');
                return;
            }
            
            if (amount > 2000) {
                alert('Maximum purchase amount is 2000 HYPE tokens');
                return;
            }
            
            try {
                console.log(`Processing purchase of ${amount} HYPE tokens for ${currentWalletAddress}`);
                
                // Simulate transaction
                alert(`Purchase initiated!\n\nAmount: ${amount} HYPE tokens\nFLOW Received: ${(amount * 25000).toLocaleString()}\nTotal: $${(amount * 12.5).toFixed(2)}\n\nTransaction will be processed on HyperEVM network.`);
                
            } catch (error) {
                console.error('Purchase failed:', error);
                alert('Purchase failed: ' + error.message);
            }
        }
    </script>
</body>
</html>